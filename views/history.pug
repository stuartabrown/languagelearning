extends layout

block content
  h2 #{title}

  // Filter input
  div(class="mb-3")
    label(for="filterInput" class="form-label") Filter Content
    input#filterInput(type="text" class="form-control" placeholder="Type to filter...")

  // Responsive table
  div(class="table-responsive")
    table(class="table table-striped table-hover table-bordered")
      thead
        tr
          th(scope="col") Language
          th(scope="col") Prompt
          th(scope="col") Response
          th(scope="col") Date Created
          th(scope="col") Audio
      include partials/history-table-body

  // JavaScript for filtering and downloading audio
  script.
    document.getElementById('filterInput').addEventListener('input', function() {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll('#contentTable tbody tr');
      rows.forEach(row => {
        const cells = Array.from(row.children);
        const matches = cells.some(cell => cell.textContent.toLowerCase().includes(filter));
        row.style.display = matches ? '' : 'none';
      });
    });

    async function downloadAudio(learningText, contentId) {
      try {
        const response = await fetch(`/${contentId}/download-audio`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ learningText }),
        });

        if (!response.ok) {
          throw new Error("Failed to fetch download URL");
        }

        const data = await response.json();
        const link = document.createElement("a");
        link.href = data.downloadUrl;
        link.download = `${contentId}.mp3`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (error) {
        console.error("Error downloading audio:", error);
        alert("Failed to download audio. Please try again.");
      }
    }
